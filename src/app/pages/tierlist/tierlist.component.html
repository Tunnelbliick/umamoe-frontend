<div class="tierlist-container">
  <div class="header">
    <div class="header-content">
      <h1>Support Card Tierlist</h1>
      <div class="header-actions">
        <mat-form-field appearance="outline" class="lb-selector">
          <mat-label>Limit Break Level</mat-label>
          <mat-select [(value)]="selectedLB" (selectionChange)="onLBChange($event.value)">
            <mat-select-trigger>
              <div class="lb-option">
                <ng-container *ngFor="let i of [0,1,2,3]">
                  <svg
                    *ngIf="i < selectedLB"
                    xmlns="http://www.w3.org/2000/svg"
                    height="24px"
                    viewBox="0 -960 960 960"
                    width="24px"
                    fill="#2196F3"
                    class="lb-diamond filled"
                  >
                    <path d="M480-64 224-480l256-416 256 416L480-64Z" />
                  </svg>
                  <svg
                    *ngIf="i >= selectedLB"
                    xmlns="http://www.w3.org/2000/svg"
                    height="24px"
                    viewBox="0 -960 960 960"
                    width="24px"
                    class="lb-diamond empty"
                  >
                    <path d="M480-64 224-480l256-416 256 416L480-64Zm0-139 170-277-170-278-169 278 169 277Zm0-277Z" />
                  </svg>
                </ng-container>
              </div>
            </mat-select-trigger>
            <mat-option *ngFor="let lb of availableLBLevels" [value]="lb.value">
              <div class="lb-option">
                <ng-container *ngFor="let i of [0,1,2,3]">
                  <svg
                    *ngIf="i < lb.value"
                    xmlns="http://www.w3.org/2000/svg"
                    height="24px"
                    viewBox="0 -960 960 960"
                    width="24px"
                    fill="#2196F3"
                    class="lb-diamond filled"
                  >
                    <path d="M480-64 224-480l256-416 256 416L480-64Z" />
                  </svg>
                  <svg
                    *ngIf="i >= lb.value"
                    xmlns="http://www.w3.org/2000/svg"
                    height="24px"
                    viewBox="0 -960 960 960"
                    width="24px"
                    class="lb-diamond empty"
                  >
                    <path d="M480-64 224-480l256-416 256 416L480-64Zm0-139 170-277-170-278-169 278 169 277Zm0-277Z" />
                  </svg>
                </ng-container>
              </div>
            </mat-option>
          </mat-select>
        </mat-form-field>
    </div>
    </div>
  </div>

  <div class="loading-container" *ngIf="loading">
    <mat-spinner></mat-spinner>
    <p>Calculating tierlist...</p>
  </div>

  <div class="main-content" *ngIf="!loading">
    <mat-sidenav-container class="sidenav-container">
 
      <!-- Main tierlist content -->
      <mat-sidenav-content class="main-tierlist">
        <!-- Power chart -->
        <app-tierlist-scatter-chart
          [cards]="getCurrentTypeCards()"
          [selectedType]="typeTierlists[selectedTabIndex].type || -1"
          [selectedLB]="selectedLB"
          (cardHover)="onCardHoverDesktop($event.card, $event.event)"
          (cardLeave)="onCardLeaveDesktop()"
          (cardClick)="onChartCardClick($event)">
        </app-tierlist-scatter-chart>

        <mat-tab-group 
          [(selectedIndex)]="selectedTabIndex" 
          class="tierlist-tabs"
          animationDuration="300ms">
          
          <mat-tab 
            *ngFor="let typeData of typeTierlists; let i = index" 
            [label]="typeData.typeName">
            
            <div class="tab-content">
              <div class="loading-container" *ngIf="typeData.loading">
                <mat-spinner diameter="40"></mat-spinner>
                <p>Loading {{ typeData.typeName }} cards...</p>
              </div>

              <div class="error-container" *ngIf="typeData.error">
                <mat-icon color="warn">error</mat-icon>
                <p>{{ typeData.error }}</p>
              </div>

              <div class="tierlist" *ngIf="!typeData.loading && !typeData.error">
                <div 
                  class="tier-row" 
                  *ngFor="let tier of typeData.tiers"
                  [attr.data-tier]="tier.tier">
                  
                  <div class="tier-label" [style.background-color]="getTierColor(tier.tier)">
                    <span class="tier-name">{{ tier.tier }}</span>
                    <span class="tier-count">({{ tier.cards.length }})</span>
                    <span class="tier-percentile">{{ getTierThreshold(tier.tier) }}</span>
                  </div>

                  <div class="tier-cards">
                    <div 
                      class="card-item"
                      *ngFor="let card of tier.cards; trackBy: trackByCardId"
                      [@cardFade]
                      (click)="onCardClickMobile(card, $event)"
                      (mouseenter)="onCardHoverDesktop(card, $event)"
                      (mouseleave)="onCardLeaveDesktop()"
                      [title]="card.name + ' - Score: ' + card.scores[selectedLB].toFixed(0)">
                      
                      <div class="card-image-container">
                        <img 
                          [src]="getCardImageUrl(card)" 
                          [alt]="card.name"
                          class="card-image">
                        
                        <!-- Power spike indicator -->
                        
                        <div class="card-overlay">
                          <div class="card-name">{{ card.name }}</div>
                          <div class="card-score" [style.color]="getScoreColor(card)">
                            {{ card.scores[selectedLB].toFixed(0) }}
                          </div>
                        </div>
                      </div>

                      <div class="card-info">
                        <div class="card-rarity">LB{{ selectedLB }}</div>
                      </div>

                      <!-- Power progression for selected card -->
                    </div>

                    <div class="empty-tier" *ngIf="tier.cards.length === 0">
                      <span>No cards in this tier</span>
                    </div>
                  </div>
                </div>

                <div class="no-cards" *ngIf="typeData.tiers.length === 0">
                  <mat-icon>info</mat-icon>
                  <p>No LB{{ selectedLB }} {{ typeData.typeName }} cards found</p>
                </div>
              </div>
            </div>
          </mat-tab>
        </mat-tab-group>
      </mat-sidenav-content>
    </mat-sidenav-container>
  </div>

  <div class="tierlist-info" *ngIf="!loading">
    <mat-card class="info-card">
      <mat-card-header>
        <mat-card-title>Tierlist Information</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <p>This tierlist shows support cards at the selected Limit Break level using percentile-based ranking.</p>
        <p>Scores are calculated based on the URA scenario optimal meta calculations.</p>
        
        <div class="tier-legend">
          <h4>Percentile-Based Rankings:</h4>
          <div class="legend-items">
            <div class="legend-item" *ngFor="let tier of ['S+', 'S', 'A', 'B', 'C', 'D']">
              <div class="legend-color" [style.background-color]="getTierColor(tier)"></div>
              <span>{{ tier }}-Tier</span>
              <span class="tier-threshold">({{ getTierThreshold(tier) }} percentile)</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Card Hover Menu -->
  <app-card-hover-menu
    [card]="hoveredCard"
    [isVisible]="hoverMenuVisible"
    [position]="hoverMenuPosition"
    (close)="hideHoverMenu()">
  </app-card-hover-menu>
</div>
